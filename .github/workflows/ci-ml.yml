name: ML-tests CI

on: [push, pull_request]

jobs:
  test-ml-service:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsndfile1 portaudio19-dev ffmpeg

      - name: Install Python dependencies
        working-directory: machine_learning_client
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Add project to PYTHONPATH
        run: |
          echo "PYTHONPATH=$PWD" >> $GITHUB_ENV

      - name: Set dummy Azure env vars
        run: |
          echo "SPEECH_KEY=dummy" >> $GITHUB_ENV
          echo "SPEECH_REGION=dummy" >> $GITHUB_ENV

      - name: Mock system modules for CI
        run: |
          echo "import sys; from unittest.mock import MagicMock; sys.modules['audioop'] = MagicMock()" > conftest.py

      - name: Run tests with coverage
        run: |
          pytest \
            machine_learning_client/tests \
            --cov=machine_learning_client.audio_store \
            --cov=machine_learning_client.convert \
            --cov=machine_learning_client.pronun_assess \
            --cov-fail-under=80 \
            --import-mode=importlib